<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ch√¢teaux & Champs ‚Äì Complet (save + upgrade + reset)</title>
<style>
:root{
  --bg:#0f1115; --panel:#171a21; --muted:#9aa4b2; --text:#e6e8eb;
  --accent:#6ee7ff; --accent-2:#7cfe9a; --danger:#ff4f4f; --violet:#5c3a99;
  --tile:42px;
}
*{box-sizing:border-box}
body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:var(--text)}
header{
  padding:14px 18px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  border-bottom:1px solid #222833; background:#111520;
}
header h1{font-size:18px; margin:0 10px 0 0}
.stat{min-width:120px; padding:8px 12px; border:1px solid #2a3245; border-radius:12px; background:#141923; text-align:center}
.stat.small{min-width:auto; padding:8px 10px}
.stat .pos{color:var(--accent-2)} .stat .neg{color:#ff9a9a} .stat .neu{color:var(--muted)}
.btn{border:1px solid #2a3245; background:#161a22; color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#1a2330,#17202b)}
.btn[disabled]{opacity:.45; cursor:not-allowed}
.btn.danger{background:linear-gradient(180deg,var(--danger),#b72f2f); border-color:#b72f2f; color:white;}
.layout{
  display:grid; grid-template-columns: 260px 1fr 380px;
  gap:18px; padding:18px; max-width:1400px; margin:0 auto;
}

/* Cartes (gauche) */
.building-card{ background:#171a21; border:1px solid #2a3245; border-radius:10px; padding:10px; margin-bottom:12px }
.building-name{ display:flex; align-items:center; gap:8px; font-size:14px; font-weight:bold }
.muted{color:var(--muted); font-size:13px}
.small{font-size:12px; color:#8b95a8}
.prod-bar{ height:8px; background:#0f1420; border-radius:5px; overflow:hidden; margin-top:6px }
.prod-fill{ height:100%; background:var(--accent-2); width:0% }              /* prod L->R */
.prod-fill.consume{ background:var(--violet); width:100%; transform-origin:right; transform:scaleX(0) } /* entretien R->L */

/* Plateau */
.board-wrap{border:1px solid #263044; border-radius:14px; padding:14px; background:#121720}
.board{display:grid; gap:6px; justify-content:center}
.cell{
  width:var(--tile); height:var(--tile); border-radius:9px; display:grid; place-items:center;
  font-size:22px; user-select:none; border:1px solid #1f2635;
  background:#0f1420; transition:background .2s ease; position: relative;
}
.cell.chateau { font-size: 20px; animation: appearZoom 0.8s ease forwards; }
.cell.house   { font-size: 18px; animation: appearZoom 0.6s ease forwards; }
@keyframes appearZoom { 0%{transform:scale(.5);opacity:0} 100%{transform:scale(1);opacity:1} }
.cell.center.glow { animation: glowPulse 1s ease-in-out infinite; }
@keyframes glowPulse { 0%,100%{ box-shadow:0 0 6px var(--accent)} 50%{ box-shadow:0 0 14px var(--accent)} }

/* Menu construction (droite) */
.build-card{ background:#171a21; border:1px solid #2a3245; border-radius:10px; padding:12px; display:grid; gap:8px; margin-bottom:12px }
.build-head{ display:flex; align-items:center; gap:8px; font-weight:700 }
.build-desc{ font-size:12px; color:var(--muted) }
.build-actions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
.build-bar{ height:8px; background:#0f1420; border-radius:5px; overflow:hidden }
.build-fill{ height:100%; background:var(--accent); width:0% } /* construction L->R */

/* +1 flottant */
.gold-float{
  position:absolute; top:-10px; left:50%; transform:translateX(-50%);
  font-size:14px; color:gold; opacity:0; animation:floatUp 1s ease forwards;
}
@keyframes floatUp{ 0%{opacity:0; transform:translate(-50%,0)} 30%{opacity:1} 100%{opacity:0; transform:translate(-50%,-20px)} }
</style>
</head>
<body>
<header>
  <h1>Ch√¢teaux & Champs</h1>
  <div class="stat">Or: <span id="gold">0</span></div>
  <div class="stat">Pop: <span id="pop">0</span></div>
  <div class="stat small">üí∞ Revenu / tick : <span id="income" class="neu">0</span></div>
  <div class="mode" style="display:flex;gap:8px;align-items:center">
    <button id="modeBtn" class="btn">Mode: Debug (2s)</button>
    <button id="soundBtn" class="btn">üîä Son: ON</button>
    <button id="resetBtn" class="btn danger">‚ü≥ Reset</button>
  </div>
</header>

<main class="layout">
  <!-- Gauche : B√¢timents (group√©s) -->
  <div id="buildingPanel"></div>

  <!-- Centre : Grille -->
  <section class="board-wrap">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px;color:var(--muted);font-size:13px;">
      <div>Carte</div>
      <div>Grille: <span id="gridSizeLabel">15√ó11</span></div>
    </div>
    <div id="board" class="board" role="grid"></div>
  </section>

  <!-- Droite : Construction/Upgrade -->
  <aside id="buildMenu">
    <!-- Ch√¢teau -->
    <div class="build-card" id="castleCard">
      <div class="build-head" id="castleHead">üè∞ Ch√¢teau</div>
      <div class="build-desc" id="castleDesc">Temps 10s ‚Ä¢ Lance la production : <b>+1 or / tick</b></div>
      <div class="build-bar"><div class="build-fill" id="castleFill"></div></div>
      <div class="build-actions" id="castleActions">
        <button class="btn primary" id="buildCastleBtn">Construire</button>
        <span class="small muted" id="castleMsg">‚Äî</span>
      </div>
    </div>

    <!-- Maison -->
    <div class="build-card" id="houseCard" style="display:none">
      <div class="build-head">üè† Maison</div>
      <div class="build-desc">Co√ªt <b>5 or</b> ‚Ä¢ Temps 5s ‚Ä¢ Entretien <b>‚àí0,5 or / tick</b> ‚Ä¢ +2 population</div>
      <div class="build-bar"><div class="build-fill" id="houseFill"></div></div>
      <div class="build-actions">
        <button class="btn" id="buildHouseBtn">Construire</button>
        <span class="small muted" id="houseMsg">‚Äî</span>
      </div>
    </div>
  </aside>
</main>

<script>
/* ====== Constantes & √©tat ====== */
const SAVE_KEY = 'CC_SAVE_V1';
const cols = 15, rows = 11;
const SPEEDS = { debug: 2000, normal: 60000 };
let prodTimeMs = SPEEDS.debug;

let gold = 0, pop = 0;
let houses = 0;
let chateauConstruit = false;
let castleIncome = 1;       // +1/tick de base, +2 apr√®s upgrade
let castleUpgraded = false;
let muted = false;

let goldIntervalId = null;
const occupied = new Set();

/* ====== DOM ====== */
const board = document.getElementById('board');
const buildingPanel = document.getElementById('buildingPanel');
const modeBtn = document.getElementById('modeBtn');
const soundBtn = document.getElementById('soundBtn');
const resetBtn = document.getElementById('resetBtn');
const incomeSpan = document.getElementById('income');
const goldSpan = document.getElementById('gold');
const popSpan = document.getElementById('pop');

const castleCard = document.getElementById('castleCard');
const castleHead = document.getElementById('castleHead');
const castleDesc = document.getElementById('castleDesc');
const castleFill = document.getElementById('castleFill');
const castleActions = document.getElementById('castleActions');
const castleMsg = document.getElementById('castleMsg');
let buildCastleBtn = document.getElementById('buildCastleBtn');

const houseCard = document.getElementById('houseCard');
const buildHouseBtn = document.getElementById('buildHouseBtn');
const houseFill = document.getElementById('houseFill');
const houseMsg = document.getElementById('houseMsg');

/* ====== Grille ====== */
const centerR = Math.floor(rows/2), centerC = Math.floor(cols/2);
board.style.gridTemplateColumns = `repeat(${cols}, var(--tile))`;
board.style.gridTemplateRows = `repeat(${rows}, var(--tile))`;

function idx(r,c){ return r*cols + c; }

for (let r=0;r<rows;r++){
  for (let c=0;c<cols;c++){
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.r = r; cell.dataset.c = c;
    if (r===centerR && c===centerC){ cell.classList.add('center'); cell.id='centerCell'; }
    board.appendChild(cell);
  }
}

/* ====== Utils affichage ====== */
function setIncomeLabel(v){
  const cls = v>0 ? 'pos' : v<0 ? 'neg' : 'neu';
  incomeSpan.className = cls;
  incomeSpan.textContent = (Math.round(v*100)/100).toString();
}
function currentIncome(){ return (chateauConstruit?castleIncome:0) - 0.5*houses; }
function updateIncome(){ setIncomeLabel(currentIncome()); }
function updateGold(){ goldSpan.textContent = (Math.round(gold*100)/100).toString(); }
function updatePop(){ popSpan.textContent = pop.toString(); }
function flash(el,msg,color='var(--accent-2)'){ el.textContent = msg; el.style.color = color; setTimeout(()=>{ el.style.color='var(--muted)'; },900); }

/* ====== Son ====== */
soundBtn.addEventListener('click', ()=>{
  muted = !muted;
  soundBtn.textContent = muted ? 'üîá Son: OFF' : 'üîä Son: ON';
  saveState();
});
function playBeep(){
  if (muted) return;
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o = ctx.createOscillator(), g = ctx.createGain();
  o.type='square'; o.frequency.setValueAtTime(880, ctx.currentTime);
  g.gain.setValueAtTime(0.05, ctx.currentTime);
  o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.1);
}

/* ====== Mode Debug/Normal ====== */
modeBtn.addEventListener('click', ()=>{
  prodTimeMs = (prodTimeMs===SPEEDS.debug) ? SPEEDS.normal : SPEEDS.debug;
  modeBtn.textContent = `Mode: ${prodTimeMs===SPEEDS.debug?'Debug (2s)':'Normal (60s)'}`;
  if (goldIntervalId) clearInterval(goldIntervalId);
  if (chateauConstruit) startGoldInterval();
  document.querySelectorAll('.building-card').forEach(card=>{
    if (card.prodInterval) clearInterval(card.prodInterval);
    updateProdLabel(card);
    resetAndAnimateBar(card);
  });
  updateIncome();
  saveState();
});

/* ====== Reset ====== */
resetBtn.addEventListener('click', ()=>{
  if (confirm('Voulez-vous vraiment r√©initialiser la partie ?')){
    localStorage.removeItem(SAVE_KEY);
    location.reload();
  }
});

/* ====== Construction/Upgrade : Ch√¢teau ====== */
buildCastleBtn.addEventListener('click', onBuildCastle);

function onBuildCastle(){
  if (chateauConstruit) return;
  castleFill.style.transition = 'none'; castleFill.style.width = '0%';
  requestAnimationFrame(()=>{
    castleFill.style.transition = 'width 10s linear';
    castleFill.style.width = '100%';
  });
  buildCastleBtn.disabled = true;

  setTimeout(()=>{
    const centerCell = document.getElementById('centerCell');
    centerCell.classList.remove('glow');
    centerCell.classList.add('chateau');
    centerCell.textContent = 'üè∞';
    chateauConstruit = true;
    occupied.add(idx(centerR,centerC));

    transformCastleCardToUpgrade();   // ‚ûú devient "Am√©liorer (10 or)"
    ensureCastleCard();               // ‚ûú carte √† gauche
    startGoldInterval();
    updateIncome();
    saveState();
  }, 10000);

  document.getElementById('centerCell').classList.add('glow');
  flash(castleMsg,'Construction en cours (10s)‚Ä¶');
}

function transformCastleCardToUpgrade(){
  // Montre la carte Maison
  houseCard.style.display = '';

  // Titre/desc + actions du ch√¢teau
  castleHead.textContent = 'üè∞ Ch√¢teau (Niveau ' + (castleUpgraded?2:1) + ')';
  castleDesc.innerHTML = `Production actuelle : <b>+${castleIncome} or / tick</b> ‚Ä¢ Am√©lioration : <b>+2 or / tick</b> (co√ªt 10 or)`;
  castleActions.innerHTML = `
    <button class="btn primary" id="upgradeCastleBtn" ${castleUpgraded?'disabled':''}>${castleUpgraded?'Am√©lior√© ‚úì':'Am√©liorer (10 or)'}</button>
    <span class="small muted" id="castleMsg">‚Äî</span>
  `;
  // Re-lier refs
  window.upgradeCastleBtn = document.getElementById('upgradeCastleBtn');
  window.castleMsg = document.getElementById('castleMsg');
  upgradeCastleBtn.addEventListener('click', onUpgradeCastle);
}

function onUpgradeCastle(){
  if (castleUpgraded) return;
  if (gold < 10){ flash(castleMsg,'Pas assez d‚Äôor (10 requis).','#ff9a9a'); return; }
  gold -= 10; updateGold();

  // petite anim 1s
  castleFill.style.transition = 'none'; castleFill.style.width = '0%';
  requestAnimationFrame(()=>{
    castleFill.style.transition = 'width 1s linear';
    castleFill.style.width = '100%';
  });

  setTimeout(()=>{
    castleUpgraded = true;
    castleIncome = 2; // upgrade appliqu√©e
    castleHead.textContent = 'üè∞ Ch√¢teau (Niveau 2)';
    castleDesc.innerHTML = `Production am√©lior√©e : <b>+${castleIncome} or / tick</b>`;
    upgradeCastleBtn.disabled = true;
    upgradeCastleBtn.textContent = 'Am√©lior√© ‚úì';

    const card = document.querySelector('.building-card[data-kind="castle"]');
    if (card){ updateProdLabel(card); resetAndAnimateBar(card); }
    updateIncome();
    saveState();
  }, 1000);
}

/* ====== Construction : Maison ====== */
buildHouseBtn.addEventListener('click', ()=>{
  if (!chateauConstruit) return;
  if (gold < 5){ flash(houseMsg,'Pas assez d‚Äôor (5 requis).','#ff9a9a'); return; }

  gold -= 5; updateGold(); updateIncome(); saveState();

  buildHouseBtn.disabled = true;
  houseFill.style.transition = 'none'; houseFill.style.width = '0%';
  requestAnimationFrame(()=>{
    houseFill.style.transition = 'width 5s linear';
    houseFill.style.width = '100%';
  });

  setTimeout(()=>{
    buildHouseBtn.disabled = false;
    houseFill.style.transition = 'none'; houseFill.style.width = '0%';

    const cell = getRandomFreeCell();
    if (!cell){ flash(houseMsg,"Plus d‚Äôemplacements libres !",'#ff9a9a'); return; }
    cell.classList.add('house'); cell.textContent = 'üè†';
    occupied.add(idx(+cell.dataset.r,+cell.dataset.c));

    houses += 1; pop += 2; updatePop(); updateIncome();
    upsertHousesCard();
    flash(houseMsg,`Maison construite (+2 pop, -0,5 or/tick).`);
    saveState();
  }, 5000);
});

function getRandomFreeCell(){
  const free = [];
  const nodes = board.children;
  for (let i=0;i<nodes.length;i++) if (!occupied.has(i)) free.push(nodes[i]);
  if (!free.length) return null;
  return free[Math.floor(Math.random()*free.length)];
}

/* ====== Revenus & panneau gauche ====== */
function startGoldInterval(){
  goldIntervalId = setInterval(()=>{
    const inc = currentIncome();
    gold += inc;
    updateGold();
    updateIncome();
    showGoldGain(inc);
    playBeep();
    saveState();
  }, prodTimeMs);
}

function ensureCastleCard(){
  let card = document.querySelector('.building-card[data-kind="castle"]');
  if (!card){
    card = createBuildingCard('Ch√¢teau','üè∞','castle');
    buildingPanel.appendChild(card);
  }
  updateProdLabel(card);
  resetAndAnimateBar(card);
}

function upsertHousesCard(){
  let card = document.querySelector('.building-card[data-kind="house"]');
  if (!card){
    card = createBuildingCard('Maisons','üè†','house', houses);
    buildingPanel.appendChild(card);
  }
  card.dataset.count = String(houses);
  card.querySelector('.building-name').textContent = `üè† Maisons √ó ${houses}`;
  updateProdLabel(card);
  resetAndAnimateBar(card);
}

function createBuildingCard(name, icon, kind, count=0){
  const card = document.createElement('div');
  card.className = 'building-card';
  card.dataset.kind = kind;
  card.dataset.count = String(count);
  const isConsume = kind==='house';
  card.innerHTML = `
    <div class="building-name">${icon} ${kind==='house'? name+' √ó '+count : name}</div>
    <div class="prod-label small"></div>
    <div class="prod-bar"><div class="prod-fill ${isConsume?'consume':''}"></div></div>
  `;
  card.prodFill = card.querySelector('.prod-fill');
  card.prodLabel = card.querySelector('.prod-label');
  return card;
}

function updateProdLabel(card){
  const kind = card.dataset.kind;
  const tickLabel = prodTimeMs===SPEEDS.normal ? '60s' : '2s';
  if (kind==='castle'){
    card.prodLabel.textContent = `+${castleIncome} or / ${tickLabel}`;
  } else {
    const count = Number(card.dataset.count || houses);
    const total = 0.5 * count;
    card.prodLabel.textContent = `Entretien ‚àí0,5 √ó ${count} = ‚àí${total} or / ${tickLabel}`;
  }
}

function resetAndAnimateBar(card){
  const fill = card.prodFill;
  const isConsume = fill.classList.contains('consume');

  if (isConsume){
    fill.style.transition = 'none';
    fill.style.transform = 'scaleX(0)';
    setTimeout(()=>{
      fill.style.transition = `transform ${prodTimeMs}ms linear`;
      fill.style.transform = 'scaleX(1)';
    },50);
    if (card.prodInterval) clearInterval(card.prodInterval);
    card.prodInterval = setInterval(()=>{
      fill.style.transition = 'none';
      fill.style.transform = 'scaleX(0)';
      setTimeout(()=>{
        fill.style.transition = `transform ${prodTimeMs}ms linear`;
        fill.style.transform = 'scaleX(1)';
      },50);
    }, prodTimeMs);
  } else {
    fill.style.transition = 'none';
    fill.style.width = '0%';
    setTimeout(()=>{
      fill.style.transition = `width ${prodTimeMs}ms linear`;
      fill.style.width = '100%';
    },50);
    if (card.prodInterval) clearInterval(card.prodInterval);
    card.prodInterval = setInterval(()=>{
      fill.style.transition = 'none';
      fill.style.width = '0%';
      setTimeout(()=>{
        fill.style.transition = `width ${prodTimeMs}ms linear`;
        fill.style.width = '100%';
      },50);
    }, prodTimeMs);
  }
}

/* +1 flottant */
function showGoldGain(income){
  const centerCell = document.getElementById('centerCell');
  const fx = document.createElement('div');
  fx.className = 'gold-float';
  fx.textContent = `${income>=0?'+':''}${Math.round(income*100)/100}`;
  fx.style.color = income>=0 ? 'gold' : '#ff9a9a';
  centerCell.appendChild(fx);
  setTimeout(()=>fx.remove(),1000);
}

/* ====== Sauvegarde ====== */
function saveState(){
  try{
    const data = {
      gold, pop, houses,
      chateauConstruit, castleIncome, castleUpgraded,
      muted,
      mode: (prodTimeMs===SPEEDS.debug ? 'debug' : 'normal'),
      occupied: Array.from(occupied),
      v: 1, cols, rows
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
  }catch(e){}
}

function loadState(){
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return false;
  try{
    const s = JSON.parse(raw);
    if (!s || s.v!==1) return false;

    gold = s.gold ?? 0;
    pop = s.pop ?? 0;
    houses = s.houses ?? 0;
    chateauConstruit = !!s.chateauConstruit;
    castleIncome = s.castleIncome ?? 1;
    castleUpgraded = !!s.castleUpgraded;
    muted = !!s.muted;

    prodTimeMs = (s.mode==='normal') ? SPEEDS.normal : SPEEDS.debug;
    modeBtn.textContent = `Mode: ${prodTimeMs===SPEEDS.debug?'Debug (2s)':'Normal (60s)'}`;
    soundBtn.textContent = muted ? 'üîá Son: OFF' : 'üîä Son: ON';

    if (Array.isArray(s.occupied)){ s.occupied.forEach(i=>occupied.add(i)); }

    // Visuel : ch√¢teau + upgrade
    if (chateauConstruit){
      const centerCell = document.getElementById('centerCell');
      centerCell.classList.add('chateau');
      centerCell.textContent = 'üè∞';
      transformCastleCardToUpgrade();
      if (castleUpgraded){
        const upBtn = document.getElementById('upgradeCastleBtn');
        castleHead.textContent = 'üè∞ Ch√¢teau (Niveau 2)';
        castleDesc.innerHTML = `Production am√©lior√©e : <b>+${castleIncome} or / tick</b>`;
        if (upBtn){ upBtn.disabled = true; upBtn.textContent = 'Am√©lior√© ‚úì'; }
      }
      ensureCastleCard();
    }
    // Maisons
    if (houses > 0){
      const nodes = board.children;
      Array.from(occupied).forEach(i=>{
        if (i !== idx(centerR,centerC)){
          const cell = nodes[i];
          if (cell){ cell.classList.add('house'); cell.textContent = 'üè†'; }
        }
      });
      upsertHousesCard();
    }

    updateGold(); updatePop(); updateIncome();

    if (chateauConstruit) startGoldInterval();
    return true;
  }catch(e){ return false; }
}

/* ====== Init ====== */
updateGold(); updatePop(); updateIncome();
if (!loadState()){ saveState(); }
</script>
</body>
</html>
