<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ch√¢teaux & Champs ‚Äì Online (Auth + Menu + Jeu)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --muted:#9aa4b2; --text:#e6e8eb;
    --accent:#6ee7ff; --accent-2:#7cfe9a; --danger:#ff7a7a;
    --tile:42px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:#0f1115; color:var(--text)}
  header{padding:14px 18px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    border-bottom:1px solid #222833; background:#111520; position:sticky; top:0; z-index:5}
  header h1{font-size:18px; margin:0 10px 0 0}
  .btn{border:1px solid #2a3245; background:#161a22; color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#1a2330,#17202b)}
  .btn[disabled]{opacity:.45; cursor:not-allowed}
  input, select{border:1px solid #2a3245; background:#161a22; color:#e6e8eb; padding:10px 12px; border-radius:10px}
  .stat{min-width:120px; padding:8px 12px; border:1px solid #2a3245; border-radius:12px; background:#141923; text-align:center}
  .layout{display:grid; grid-template-columns: 1fr 360px; gap:18px; padding:18px; max-width:1200px; margin:0 auto}
  @media (max-width: 980px){ .layout{grid-template-columns:1fr} }
  .card{padding:14px; border:1px solid #283043; border-radius:14px; background:#121720}
  .card h3{margin:0 0 10px 0; font-size:15px; color:#d6d9df}
  .muted{color:var(--muted); font-size:13px}
  .small{font-size:12px; color:#8b95a8}
  .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .right{margin-left:auto}

  /* Board */
  .board-wrap{border:1px solid #263044; border-radius:14px; padding:14px; background:#121720}
  .board{display:grid; gap:6px; justify-content:center}
  .cell{
    width:var(--tile); height:var(--tile); border-radius:9px; display:grid; place-items:center;
    font-size:22px; user-select:none; border:1px solid #1f2635;
    background:#0f1420; transition:background .2s ease
  }
  .player{background:linear-gradient(160deg,#0e3b1c,#0a2914); border-color:#1c3a28}
  .enemy{background:linear-gradient(160deg,#3b1212,#2a0c0c); border-color:#3a1f23}

  /* Farms incremental */
  .farm-grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:6px}
  .farm{
    height:44px; border:1px dashed #33405a; border-radius:8px; display:grid; place-items:center; font-size:18px; color:#9fb3c8;
    background:#0f1420;
  }
  .farm.open{border-style:solid; color:#b9c7d9}
  .farm.filled{border-style:solid; background:linear-gradient(180deg,#12211a,#0f1b15); color:#7cfe9a}
  .log-head{display:flex; align-items:center; justify-content:space-between}
  .link{cursor:pointer; color:#9aa4b2; text-decoration:underline; font-size:12px}

  /* Overlay Auth */
  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:99}
  .modal{width:min(560px, 92vw); background:#121720; border:1px solid #2a3245; border-radius:14px; padding:16px}
  .tabs{display:flex; gap:6px; margin-bottom:10px}
  .tab{flex:1; text-align:center; padding:10px; border-radius:10px; border:1px solid #2a3245; cursor:pointer}
  .tab.active{background:#161a22}
  .row{display:grid; grid-template-columns: 1fr; gap:10px; margin:10px 0}
  .menu{max-width:900px; margin:24px auto; padding:16px; border:1px solid #2a3245; border-radius:14px; background:#121720; display:none}
  .menu h2{margin-top:0}
</style>
</head>
<body>
<header>
  <h1>Ch√¢teaux & Champs</h1>
  <div id="userSlot" class="muted small">Non connect√©</div>
  <div class="right flex">
    <button class="btn" id="btnLogout" style="display:none">D√©connexion</button>
  </div>
</header>

<!-- MAIN MENU -->
<section id="mainMenu" class="menu">
  <h2>Menu</h2>
  <div class="flex">
    <button class="btn primary" id="btnPlay">‚ñ∂Ô∏è Play</button>
    <button class="btn" id="btnSettings">‚öôÔ∏è Settings</button>
  </div>
  <div class="small muted" style="margin-top:8px">Connect√© en tant que <b id="menuUser"></b> ‚Äî Royaume : <b id="menuRealm"></b> (Roi : <b id="menuKing"></b>)</div>
</section>

<!-- GAME (hidden until Play) -->
<main id="gameRoot" class="layout" style="display:none">
  <!-- LEFT: MAP -->
  <section class="board-wrap">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
      <div class="muted">Carte (conqu√™te via <b>fantassins</b>, √©conomie en temps r√©el)</div>
      <div class="muted">Grille: <span id="gridSizeLabel">10√ó10</span></div>
    </div>
    <div id="board" class="board" role="grid" aria-label="Plateau"></div>
    <div class="small" style="margin-top:8px; color:#9aa4b2">
      üè∞ Ton ch√¢teau (milieu droit) ‚Ä¢ üèØ Ch√¢teau IA (milieu gauche)
    </div>
  </section>

  <!-- RIGHT: ECONOMY -->
  <aside style="display:grid; gap:14px; height:fit-content">
    <div class="card">
      <h3>Fermes & paysans</h3>
      <div class="muted small" style="margin-bottom:8px">
        1 <b>paysan</b> cultivant 1 <b>ferme</b> produit <b>+1 or / 10 s</b>. <br/>D√©part : 1 ferme ouverte sur 9.
      </div>
      <div class="flex" style="margin-bottom:8px">
        <button class="btn" id="buyPeasant">Acheter paysan (5 or)</button>
        <button class="btn" id="unlockFarm">D√©verrouiller une ferme (5 or)</button>
        <span class="small muted" id="peasantCount">0 paysan</span>
      </div>
      <div class="muted small" style="margin:8px 0 6px">Fermes (max 9)</div>
      <div id="farmGrid" class="farm-grid"></div>
      <div class="small muted" style="margin-top:6px">Prod actuelle : <b id="prodNow">0</b> or / 10 s</div>
    </div>

    <div class="card">
      <h3>Arm√©e (optionnel)</h3>
      <div class="muted small" style="margin-bottom:8px">
        Les <b>fantassins</b> tentent des captures √† la fin de chaque tour. L‚Äô√©conomie tourne en continu.
      </div>
      <div class="flex" style="margin-bottom:8px">
        <button class="btn" id="buyFootman">Acheter fantassin (10 or)</button>
        <span class="small muted" id="footmanCount">0 fantassin</span>
      </div>
      <div class="small muted">Proba capture: neutre 65% ‚Ä¢ vs IA 40%</div>
    </div>

    <div class="card">
      <h3>Param√®tres</h3>
      <label class="small muted">Taille de la grille</label>
      <div class="flex">
        <input id="sizeInput" type="number" min="7" max="25" value="10" class="btn" style="width:100%">
        <button class="btn" id="resizeBtn">Redimensionner</button>
      </div>
    </div>

    <div class="card">
      <div class="log-head">
        <h3>Journal</h3>
        <span id="toggleLog" class="link">R√©duire</span>
      </div>
      <div id="logBox" class="small" style="white-space:pre-wrap; color:#9aa4b2; min-height:120px; max-height:220px; overflow:auto">‚Äî</div>
    </div>
  </aside>
</main>

<!-- AUTH OVERLAY -->
<div id="authOverlay" class="overlay" style="display:none">
  <div class="modal">
    <div class="tabs">
      <div id="tabLogin" class="tab active">Se connecter</div>
      <div id="tabRegister" class="tab">Cr√©er un compte</div>
    </div>

    <!-- LOGIN -->
    <div id="viewLogin">
      <div class="row">
        <input id="loginUsername" placeholder="Pseudo (3‚Äì16)" maxlength="16">
        <input id="loginPassword" placeholder="Mot de passe (‚â•4)" type="password" maxlength="64">
      </div>
      <div class="flex">
        <button class="btn primary" id="btnDoLogin">Connexion</button>
        <div id="loginMsg" class="small muted"></div>
      </div>
    </div>

    <!-- REGISTER + REALM -->
    <div id="viewRegister" style="display:none">
      <div class="row">
        <input id="regUsername" placeholder="Pseudo (3‚Äì16)" maxlength="16">
        <input id="regPassword" placeholder="Mot de passe (‚â•4)" type="password" maxlength="64">
      </div>
      <div class="row">
        <input id="realmName" placeholder="Nom du royaume (3‚Äì24)" maxlength="24">
        <input id="kingName" placeholder="Nom du roi (3‚Äì24)" maxlength="24">
      </div>
      <div class="flex">
        <button class="btn primary" id="btnDoRegister">Cr√©er mon royaume</button>
        <div id="regMsg" class="small muted"></div>
      </div>
    </div>
  </div>
</div>

<!-- Stats bar -->
<div id="statsBar" style="display:none; padding:8px 18px; border-top:1px solid #222833; background:#111520">
  <div class="flex">
    <div class="stat" id="goldStat">Or: 0</div>
    <div class="stat" id="incomeStat">Prod: 0 or / 10 s</div>
    <div class="stat" id="turnStat" title="Tours (pour la partie conqu√™te)">Tour: 0</div>
  </div>
</div>

<!-- Firebase (Compat CDN) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  // === Ta configuration Firebase (coll√©e) ===
  const firebaseConfig = {
    apiKey: "AIzaSyB-gDB8UF79FNHkHhlLavrzvjeOb6vtRh8",
    authDomain: "conquest-db-c9106.firebaseapp.com",
    databaseURL: "https://conquest-db-c9106-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "conquest-db-c9106",
    storageBucket: "conquest-db-c9106.firebasestorage.app",
    messagingSenderId: "190573879824",
    appId: "1:190573879824:web:3ee02b7f14214d877ee095"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
(()=>{
// ===== Helpers =====
const $ = sel => document.querySelector(sel);
const on = (el, ev, fn) => el.addEventListener(ev, fn);
const SAVE_KEY = 'inc_v5';
const SESSION_KEY = 'cc_session_v1'; // session {username}

// SHA-256 hex (pour mot de passe simple c√¥t√© client)
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ===== Auth UI =====
const authOverlay = $('#authOverlay');
const tabLogin = $('#tabLogin');
const tabRegister = $('#tabRegister');
const viewLogin = $('#viewLogin');
const viewRegister = $('#viewRegister');
const loginUsername = $('#loginUsername');
const loginPassword = $('#loginPassword');
const btnDoLogin = $('#btnDoLogin');
const loginMsg = $('#loginMsg');

const regUsername = $('#regUsername');
const regPassword = $('#regPassword');
const realmName = $('#realmName');
const kingName = $('#kingName');
const btnDoRegister = $('#btnDoRegister');
const regMsg = $('#regMsg');

const userSlot = $('#userSlot');
const btnLogout = $('#btnLogout');
const mainMenu = $('#mainMenu');
const menuUser = $('#menuUser');
const menuRealm = $('#menuRealm');
const menuKing = $('#menuKing');
const btnPlay = $('#btnPlay');
const btnSettings = $('#btnSettings');
const gameRoot = $('#gameRoot');
const statsBar = $('#statsBar');

let currentUser = null; // {username}
let currentProfile = null; // user doc

function showAuth(){ authOverlay.style.display='flex'; }
function hideAuth(){ authOverlay.style.display='none'; }
function switchTab(which){
  const login = which==='login';
  tabLogin.classList.toggle('active', login);
  tabRegister.classList.toggle('active', !login);
  viewLogin.style.display = login ? 'block' : 'none';
  viewRegister.style.display = login ? 'none' : 'block';
}

// Firestore helpers
function usersCol(){ return firebase.firestore().collection('users'); }
function userDocId(username){ return (username||'').trim().toLowerCase(); }
async function getUser(username){
  const snap = await usersCol().doc(userDocId(username)).get();
  return snap.exists ? { id:snap.id, ...snap.data() } : null;
}
async function createUser({username, passHash, realmName, kingName}){
  const now = new Date().toISOString();
  const doc = {
    username,
    passSha256: passHash,
    createdAt: now,
    realm: { name: realmName, king: kingName }
  };
  await usersCol().doc(userDocId(username)).set(doc, {merge:false});
  return doc;
}

// Session
function saveSession(username){
  localStorage.setItem(SESSION_KEY, JSON.stringify({username}));
}
function loadSession(){
  try{ const raw = localStorage.getItem(SESSION_KEY); return raw? JSON.parse(raw): null; }catch(e){ return null; }
}
function clearSession(){ localStorage.removeItem(SESSION_KEY); }

function updateHeader(){
  if(currentUser){
    userSlot.textContent = `Connect√© : ${currentUser.username}`;
    btnLogout.style.display = 'inline-flex';
  }else{
    userSlot.textContent = 'Non connect√©';
    btnLogout.style.display = 'none';
  }
}

// Login
on(btnDoLogin, 'click', async ()=>{
  const u = loginUsername.value.trim();
  const p = loginPassword.value;
  loginMsg.textContent='';
  if(u.length<3 || p.length<4){ loginMsg.textContent='Pseudo ‚â•3, mdp ‚â•4.'; return; }
  const doc = await getUser(u);
  if(!doc){ loginMsg.textContent='Compte introuvable. Passe sur l‚Äôonglet ‚ÄúCr√©er un compte‚Äù.'; return; }
  const hash = await sha256Hex(p);
  if(hash !== doc.passSha256){ loginMsg.textContent='Mot de passe incorrect.'; return; }
  currentUser = {username: doc.username};
  currentProfile = doc;
  saveSession(doc.username);
  updateHeader();
  hideAuth();
  showMenu();
});

// Register + Realm
on(btnDoRegister, 'click', async ()=>{
  const u = regUsername.value.trim();
  const p = regPassword.value;
  const rn = realmName.value.trim();
  const kn = kingName.value.trim();
  regMsg.textContent='';
  if(u.length<3){ regMsg.textContent='Pseudo trop court (‚â•3).'; return; }
  if(p.length<4){ regMsg.textContent='Mot de passe trop court (‚â•4).'; return; }
  if(rn.length<3 || kn.length<3){ regMsg.textContent='Royaume et Roi ‚â•3 caract√®res.'; return; }
  const exists = await getUser(u);
  if(exists){ regMsg.textContent='Ce pseudo est d√©j√† pris.'; return; }
  const hash = await sha256Hex(p);
  const doc = await createUser({username:u, passHash:hash, realmName:rn, kingName:kn});
  currentUser = {username: u};
  currentProfile = doc;
  saveSession(u);
  updateHeader();
  hideAuth();
  showMenu();
});

on(tabLogin,'click',()=>switchTab('login'));
on(tabRegister,'click',()=>switchTab('register'));
on(btnLogout,'click',()=>{
  currentUser=null; currentProfile=null; clearSession(); updateHeader();
  hideGame(); hideMenu(); showAuth();
});

function showMenu(){
  menuUser.textContent = currentProfile?.username || currentUser?.username || '';
  menuRealm.textContent = currentProfile?.realm?.name || '‚Äî';
  menuKing.textContent = currentProfile?.realm?.king || '‚Äî';
  mainMenu.style.display='block';
  statsBar.style.display='none';
  gameRoot.style.display='none';
}
function hideMenu(){ mainMenu.style.display='none'; }
function showGame(){
  statsBar.style.display='block';
  gameRoot.style.display='grid';
  hideMenu();
}
function hideGame(){ statsBar.style.display='none'; gameRoot.style.display='none'; }

on(btnPlay,'click', showGame);
on(btnSettings,'click', ()=>{
  alert('Settings √† venir : changer nom du roi, audio, etc.');
});

// Auto session
(async function initAuth(){
  const sess = loadSession();
  if(sess && sess.username){
    const doc = await getUser(sess.username);
    if(doc){
      currentUser = {username: doc.username};
      currentProfile = doc;
      updateHeader();
      showMenu();
      return;
    }
  }
  // No session
  updateHeader();
  switchTab('login');
  showAuth();
})();

})();
</script>

<!-- === GAME LOGIC (v5 √©conomie temps r√©el) === -->
<script>
(()=>{
// v5 game logic (√©conomie + carte + UI)
const CELL = { NEUTRAL:0, PLAYER:1, ENEMY:2 };
const DIRS = [[1,0],[-1,0],[0,1],[0,-1]];
const SAVE_KEY = 'inc_v5';

const BRONZE_PER_OR = 100;
const BRONZE_PER_FARM_PER_SEC = 10;
const FARM_MAX = 9;
const FARM_UNLOCK_COSTS = [5,20,60,150,400,1000,2500,6000];
const PEASANT_BASE_COST = 5;
const PEASANT_INFLATION = 1.15;

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function inb(n,x,y){ return x>=0 && x<n && y>=0 && y<n; }
function neighbors(n,i,j){
  const out=[]; for(const [dx,dy] of DIRS){ const nx=i+dx,ny=j+dy; if(inb(n,nx,ny)) out.push([nx,ny]); } return out;
}
function orFromBronze(b){ return Math.floor(b/BRONZE_PER_OR); }

const state = {
  n: 10, board: [], hp: [], turn: 0,
  castles: {player:[0,0], enemy:[0,0]},
  victoryMode: 'castle',
  pNeutral: 0.65, pEnemy: 0.40, defP: 1, defE: 2,
  bronze: 0, peasants: 0, peasantCost: PEASANT_BASE_COST,
  farmsOpen: 1, farmsFilled: 0, footmen: 0,
  logs: [], logCollapsed: false
};

function newBoard(n){
  const B = Array.from({length:n}, _ => Array(n).fill(CELL.NEUTRAL));
  const mid = Math.floor(n/2);
  state.castles.enemy  = [mid, 0];
  state.castles.player = [mid, n-1];
  const [ex,ey] = state.castles.enemy;
  const [px,py] = state.castles.player;
  B[ex][ey] = CELL.ENEMY;
  B[px][py] = CELL.PLAYER;
  return B;
}
function newHP(n, defP, defE){
  const H = Array.from({length:n}, _ => Array(n).fill(1));
  const [ex,ey] = state.castles.enemy;
  const [px,py] = state.castles.player;
  H[px][py] = Math.max(defP, defP+1);
  H[ex][ey] = Math.max(defE, defE+1);
  return H;
}

function countCells(who){ let c=0; for(const r of state.board) for(const v of r) if(v===who) c++; return c; }
function frontierFor(who){
  const n=state.n, seen=new Set(), out=[];
  for(let i=0;i<n;i++) for(let j=0;j<n;j++){
    if(state.board[i][j]!==who) continue;
    for(const [nx,ny] of neighbors(n,i,j)){
      if(state.board[nx][ny]!==who){
        const k=nx+','+ny;
        if(!seen.has(k)){ seen.add(k); out.push([nx,ny]); }
      }
    }
  }
  return out;
}
function playerAutoConquer(){
  const attempts = state.footmen||0;
  if(attempts<=0) return 0;
  const front = frontierFor(CELL.PLAYER);
  if(front.length===0) return 0;
  let caps=0;
  for(let k=0;k<attempts;k++){
    if(front.length===0) break;
    const [x,y] = front[Math.floor(Math.random()*front.length)];
    const target = state.board[x][y];
    const p = (target===CELL.NEUTRAL)?state.pNeutral:state.pEnemy;
    if(Math.random() < p){
      state.hp[x][y] = Math.max(0, (state.hp[x][y]||1)-1);
      if(state.hp[x][y]===0){
        state.board[x][y]=CELL.PLAYER;
        state.hp[x][y]=state.defP;
        caps++;
      }
    }
  }
  return caps;
}
function enemyAutoExpand(){
  const enemyCount = countCells(CELL.ENEMY);
  if(enemyCount < 5) return 0;
  const front = frontierFor(CELL.ENEMY);
  if(front.length===0) return 0;
  let caps=0;
  const [x,y] = front[Math.floor(Math.random()*front.length)];
  const p = (state.board[x][y]===CELL.NEUTRAL)?0.55:0.35;
  if(Math.random()<p){
    state.hp[x][y] = Math.max(0, (state.hp[x][y]||1)-1);
    if(state.hp[x][y]===0){
      state.board[x][y]=CELL.ENEMY;
      state.hp[x][y]=state.defE;
      caps++;
    }
  }
  return caps;
}
function endTurn(){
  state.turn++;
  const p = playerAutoConquer();
  const e = enemyAutoExpand();

  if(state.victoryMode==='castle'){
    const [ex,ey] = state.castles.enemy;
    const [px,py] = state.castles.player;
    if(state.board[ex][ey] === CELL.PLAYER){ log(`üéâ Victoire (ch√¢teau ennemi) au tour ${state.turn}`); }
    if(state.board[px][py] !== CELL.PLAYER){ log(`üíÄ D√©faite (ton ch√¢teau est tomb√©) au tour ${state.turn}`); }
  }else{
    const tot = state.n*state.n, me=countCells(CELL.PLAYER);
    if(me===tot) log(`üéâ Victoire par h√©g√©monie au tour ${state.turn}`);
    if(me===0)   log(`üíÄ D√©faite : plus de territoire au tour ${state.turn}`);
  }

  log(`Tour ${state.turn}: captures ‚Üí toi ${p}, IA ${e}`);
  render(); save();
}

// Economy
function clampFarms(){ state.farmsOpen = Math.max(1, Math.min(9, state.farmsOpen||1)); }
function currentFarmsFilled(){ return Math.min(state.farmsOpen, state.peasants); }
function currentProdBronzePerSec(){ return currentFarmsFilled() * BRONZE_PER_FARM_PER_SEC; }
function canAfford(orCost){ return Math.floor(state.bronze/BRONZE_PER_OR) >= orCost; }
function spend(orCost){ if(!canAfford(orCost)) return false; state.bronze -= orCost*BRONZE_PER_OR; return true; }
function buyPeasant(){
  const cost = state.peasantCost;
  if(!spend(cost)) return false;
  state.peasants += 1;
  state.peasantCost = Math.ceil(state.peasantCost * PEASANT_INFLATION);
  log(`üë®‚Äçüåæ +1 paysan (co√ªt prochain: ${state.peasantCost} or)`);
  updateFarmsFilled();
  render(); save(); return true;
}
function nextUnlockCost(){ const o=state.farmsOpen; if(o>=FARM_MAX) return null; return FARM_UNLOCK_COSTS[o-1]; }
function unlockFarm(){
  const cost = nextUnlockCost(); if(cost==null) return false;
  if(!spend(cost)) return false;
  state.farmsOpen = Math.max(1, Math.min(9, state.farmsOpen+1));
  log(`üóùÔ∏è Nouvelle ferme ouverte (${state.farmsOpen}/${FARM_MAX}).`);
  updateFarmsFilled(); render(); save(); return true;
}
function updateFarmsFilled(){ state.farmsFilled = currentFarmsFilled(); }
function tickEconomy(){
  const inc = currentProdBronzePerSec();
  if(inc>0){ state.bronze += inc; renderMoneyOnly(); }
}

// UI
const el = {
  board: document.getElementById('board'),
  gold: document.getElementById('goldStat'),
  income: document.getElementById('incomeStat'),
  turn: document.getElementById('turnStat'),
  step: document.getElementById('stepBtn'),
  reset: document.getElementById('resetBtn'),
  buyP: document.getElementById('buyPeasant'),
  buyF: document.getElementById('buyFootman'),
  pCount: document.getElementById('peasantCount'),
  farmGrid: document.getElementById('farmGrid'),
  sizeInput: document.getElementById('sizeInput'),
  resizeBtn: document.getElementById('resizeBtn'),
  gridSizeLabel: document.getElementById('gridSizeLabel'),
  log: document.getElementById('logBox'),
  victory: document.getElementById('victoryMode'),
  unlockFarm: document.getElementById('unlockFarm'),
  prodNow: document.getElementById('prodNow'),
  toggleLog: document.getElementById('toggleLog'),
};

function renderBoard(){
  const n = state.n;
  el.board.style.gridTemplateColumns = `repeat(${n}, var(--tile))`;
  el.board.innerHTML='';
  for(let i=0;i<n;i++){
    for(let j=0;j<n;j++){
      const v = state.board[i][j];
      const d = document.createElement('div');
      d.className = 'cell ' + (v===CELL.NEUTRAL?'neutral':v===CELL.PLAYER?'player':'enemy');
      const isPC = (i===state.castles.player[0] && j===state.castles.player[1]);
      const isEC = (i===state.castles.enemy[0]  && j===state.castles.enemy[1]);
      d.textContent = (v===CELL.NEUTRAL)?'üè≥':(v===CELL.PLAYER?(isPC?'üè∞':'üü©'):(isEC?'üèØ':'üü•'));
      d.title = `PV: ${state.hp[i]?.[j] ?? 1}`;
      el.board.appendChild(d);
    }
  }
}

function renderFarms(){
  el.farmGrid.innerHTML='';
  const filled = currentFarmsFilled();
  const open = state.farmsOpen;
  for(let i=0;i<FARM_MAX;i++){
    const f = document.createElement('div');
    let cls = 'farm';
    if(i<filled){ cls+=' filled'; f.textContent='üåæ'; }
    else if(i<open){ cls+=' open'; f.textContent='‚ñ¢'; }
    else { f.textContent='üîí'; }
    f.className = cls;
    el.farmGrid.appendChild(f);
  }
  const idle = Math.max(0, state.peasants - open);
  const active = Math.min(state.peasants, open);
  el.pCount.textContent = `${state.peasants} paysan${state.peasants>1?'s':''} (${active} actifs, ${idle} en attente)`;
  el.prodNow.textContent = String(filled);
}

function renderMoneyOnly(){
  const or = Math.floor(state.bronze/BRONZE_PER_OR);
  el.gold.textContent = `Or: ${or}`;
  el.income.textContent = `Prod: ${currentFarmsFilled()} or / 10 s`;
}

function render(){
  renderMoneyOnly();
  el.turn.textContent = `Tour: ${state.turn}`;
  el.victory.value = state.victoryMode;
  renderBoard();
  renderFarms();
  el.buyP.textContent = `Acheter paysan (${state.peasantCost} or)`;
  const nxt = nextUnlockCost();
  el.unlockFarm.textContent = `D√©verrouiller une ferme${nxt!=null?` (${nxt} or)`:''}`;
  el.unlockFarm.disabled = (nxt==null) || !(Math.floor(state.bronze/BRONZE_PER_OR) >= nxt);
  el.buyP.disabled = !(Math.floor(state.bronze/BRONZE_PER_OR) >= state.peasantCost);
  el.buyF.disabled = !(Math.floor(state.bronze/BRONZE_PER_OR) >= 10);
  el.gridSizeLabel.textContent = `${state.n}√ó${state.n}`;
  el.log.textContent = (state.logs.length? state.logs.slice(-10).join('\n') : '‚Äî');
  el.log.style.display = state.logCollapsed ? 'none' : 'block';
  el.toggleLog.textContent = state.logCollapsed ? 'D√©plier' : 'R√©duire';
}

function log(msg){
  const t = new Date().toLocaleTimeString();
  state.logs.push(`[${t}] ${msg}`);
  if(state.logs.length>1000) state.logs.splice(0, state.logs.length-1000);
  render();
}

// Save / Load / Reset
function save(){
  try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch(e){}
}
function load(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const s = JSON.parse(raw);
    Object.assign(state, s);
    if(!state.board || state.board.length!==state.n){ state.board = newBoard(state.n); }
    if(!state.hp || state.hp.length!==state.n){ state.hp = newHP(state.n, state.defP, state.defE); }
    state.farmsOpen = Math.max(1, Math.min(9, state.farmsOpen||1));
    state.peasantCost = Math.max(PEASANT_BASE_COST, state.peasantCost||PEASANT_BASE_COST);
    updateFarmsFilled();
    return true;
  }catch(e){ return false; }
}
function hardReset(){
  const keepN = state.n;
  const keepCastles = state.castles;
  Object.assign(state, {
    n: keepN, board:newBoard(keepN), hp:[], turn:0,
    castles: keepCastles, victoryMode: state.victoryMode,
    pNeutral:0.65, pEnemy:0.40, defP:1, defE:2,
    bronze:0, peasants:0, peasantCost:PEASANT_BASE_COST,
    farmsOpen:1, farmsFilled:0, footmen:0,
    logs:[], logCollapsed:false
  });
  state.hp = newHP(state.n, state.defP, state.defE);
  render(); save();
  log('üîÑ R√©initialisation : √©conomie et carte remises √† z√©ro.');
}

// Events
document.getElementById('buyPeasant').addEventListener('click', buyPeasant);
document.getElementById('buyFootman').addEventListener('click', ()=>{
  if(Math.floor(state.bronze/BRONZE_PER_OR) >= 10){
    state.bronze -= 10*BRONZE_PER_OR;
    state.footmen = (state.footmen||0)+1;
    log('üõ°Ô∏è +1 fantassin (tentative de capture √† la fin du tour).');
    render(); save();
  }
});
document.getElementById('unlockFarm').addEventListener('click', unlockFarm);
document.getElementById('stepBtn')?.addEventListener('click', endTurn);
document.getElementById('resetBtn')?.addEventListener('click', hardReset);
document.getElementById('resizeBtn')?.addEventListener('click', ()=>{
  let n = parseInt(document.getElementById('sizeInput').value||'10',10);
  n = Math.max(7, Math.min(25, n));
  state.n = n;
  state.board = newBoard(n);
  state.hp = newHP(n, state.defP, state.defE);
  state.turn = 0;
  render(); save();
  log(`üó∫Ô∏è Nouvelle grille ${n}√ó${n}.`);
});
document.getElementById('victoryMode')?.addEventListener('change', (e)=>{
  state.victoryMode = e.target.value;
  save();
  log(`‚öë Condition de victoire: ${state.victoryMode==='castle'?'Si√®ge (ch√¢teau)':'H√©g√©monie (contr√¥le)'}.
`);
});
document.getElementById('toggleLog')?.addEventListener('click', ()=>{
  state.logCollapsed = !state.logCollapsed;
  render(); save();
});

(function init(){
  if(!load()){
    state.board = newBoard(state.n);
    state.hp = newHP(state.n, state.defP, state.defE);
    log("Bienvenue ! Ouvre des fermes et ach√®te des paysans pour produire de l'or.");
  }else{
    updateFarmsFilled();
    render();
  }
  setInterval(tickEconomy, 1000);
  render();
})();

})();
</script>

</body>
</html>
